<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Import and Pre-processing • MetaboMate</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Data Import and Pre-processing">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-78685833-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-78685833-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MetaboMate</a>
        <span class="label label-info" data-toggle="tooltip" data-placement="bottom" title="Package in development">0.0.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/MetaboMate.html">Getting started</a>
</li>
<li>
  <a href="../reference/index.html">Documentation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Imps.html">Data Import and Pre-processing</a>
    </li>
    <li>
      <a href="../articles/MVA.html">Multivariate Statistical Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kimsche/MetaboMate">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/torben-kimhofer-6337a725/">
    <span class="fa fa-linkedin fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/torben364">
    <span class="fa fa-twitter fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Data Import and Pre-processing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kimsche/MetaboMate/blob/master/vignettes/Imps.Rmd"><code>vignettes/Imps.Rmd</code></a></small>
      <div class="hidden name"><code>Imps.Rmd</code></div>

    </div>

    
    
<p>This vignette documents a typical pre-processing workflow for NMR-based metabolic profilig using the <em>MetaboMate</em> R package. Example data represent thirty Proton NMR (<sup>1</sup>H NMR) spectra of murine urine samples collected pre and post bariatric surgery. One dimensional spectra were acquired on a 600 MHz Bruker Avance III spectrometer, equipped with a 5 mm triple resonance (TXI) probe operating at 300 K. Further information on sample collection, processing and data acquisition can be obtained from the original publication by Jia V. Li <em>et al.</em><a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>Although not essential for this tutorial, I recommend to install RStudio. RStudio is an open-source integrated development environment for R, which includes a code editor that highlights syntax, enables quick and easy access to help pages, improves workspace management and offers various tools for plotting, history and debugging. Simply put, it makes working with R a lot more efficient.</p>
</div>
<div id="reading-1d-nmr-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-1d-nmr-spectra" class="anchor"></a>Reading 1D NMR spectra</h2>
<p>The first step is to read-in NMR spectra into the R workspace. This can be accomplished with the <strong><code><a href="../reference/readBruker.html">readBruker()</a></code></strong> function, whose only imput argument is the path to the NMR experiment folder on the computer. The function recursively searches for relevant NMR files in all subfolders and imports all 1D spectra into matrix format, where spectra are represented in rows and ppm variables in columns. The folloging code chunk reads-in Proton NMR spectra that come with the package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MetaboMate)
path=<span class="kw">system.file</span>(<span class="st">"extdata/"</span>, <span class="dt">package =</span> <span class="st">"MetaboMate"</span>)
<span class="kw"><a href="../reference/readBruker.html">readBruker</a></span>(path)
<span class="co">#&gt; Reading 30 spectra.</span>
<span class="kw">ls</span>()
<span class="co">#&gt; [1] "meta" "path" "ppm"  "X"</span></code></pre></div>
<p>This function automatically adds three variables to the R workspace:</p>
<ul>
<li>
<strong>X</strong> &lt;- 1D NMR spectra (matrix)</li>
<li>
<strong>ppm</strong> &lt;- ppm variables (vector)</li>
<li>
<strong>meta</strong> &lt;- spectrometer metadata (data frame)</li>
</ul>
<p>The rownames of <strong>X</strong> are the name of the experiment folders, which can be used to match NMR spectra with sample annotation data (participant’s age, etc). The vector <strong>ppm</strong> contains the chemical shift in ppm for each of the columns in X. The dataframe <strong>meta</strong> is row-matched to X as it contains detailed information about the spectrometer acquisition and processing parameters. Each column in meta represents a different parameter (including acquistion date and run order), whereas the prefices <em>a</em> and <em>p</em> indicate if the parameter was extracted from the accquistion (<em>acqus</em>) or processing (<em>procs</em>) status files, respectively. For example, the column <em>a_RG</em> contains the receiver gain (RG) value for each spectrum, which was extracted from the experiments’ <em>acqus</em> files. A list of the most useful paramters can be found on the R help page of the function (enter <code>?readBruker()</code> in the R console). The spectrometer’s manual is a good starting point to find out about paramters that are not listed on the help page.</p>
</div>
<div id="plotting-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-spectra" class="anchor"></a>Plotting spectra</h2>
<p>For the visualisation of NMR spectra there are two low-level plotting functions (<strong><code><a href="../reference/spec.html">spec()</a></code></strong> and <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong>), which allow plotting an individual spectrum or multiple spectra, respectively. Both of these functions are fairly fast. Let’s have a first look at all imported spectra over the entire ppm range with the <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong> function.</p>
<div id="spectral-overlay-plot-with-basic-graphics-function" class="section level3">
<h3 class="hasAnchor">
<a href="#spectral-overlay-plot-with-basic-graphics-function" class="anchor"></a>Spectral overlay plot with basic graphics function</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/matspec.html">matspec</a></span>(ppm, X, <span class="dt">shift =</span> <span class="kw">range</span>(ppm))</code></pre></div>
<p><img src="Imps_files/figure-html/spec%20overlay%20I-1.png" width="691.2"></p>
<p>From this overview we can see that the spectral width ranges from -5 to approximately 15 ppm with the residual water signal resonating around 4.8 ppm.</p>
<p>There are different higher-level plotting functions available that allow a more comprehensive spectral visualisation of individual peaks or peak areas. One of this function is <strong><code><a href="../reference/specOverlay.html">specOverlay()</a></code></strong>, which is comparable to <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong> shown above.</p>
<p>For illustration purposes we plot the TSP signal (a component of the sample preparation buffer) coloured according to the receiver gain (<em>RG</em>) parameter in <em>meta</em> dataframe, the linetype corresponds to the experiment type (<em>EXP</em>) defined with the spectrometer operation software.</p>
</div>
<div id="spectral-overlay-plot-with-ggplot2" class="section level3">
<h3 class="hasAnchor">
<a href="#spectral-overlay-plot-with-ggplot2" class="anchor"></a>Spectral overlay plot with ggplot2</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot TSP signal</span>
<span class="kw"><a href="../reference/specOverlay.html">specOverlay</a></span>(X, ppm, <span class="dt">shift=</span><span class="kw">c</span>(<span class="op">-</span><span class="fl">0.05</span>,<span class="fl">0.05</span>), 
            <span class="dt">an=</span><span class="kw">list</span>(<span class="st">'Facet'</span>=<span class="st">'All spectra'</span>, <span class="co"># facetting (here: a single panel) </span>
                    <span class="st">'Receiver Gain'</span>=<span class="kw">as.numeric</span>(meta<span class="op">$</span>a_RG), <span class="co"># colour scale</span>
                    <span class="st">'Experiment'</span>=<span class="kw">factor</span>(meta<span class="op">$</span>a_EXP))) <span class="co"># linetype</span></code></pre></div>
<p><img src="Imps_files/figure-html/spec%20overlay%20II-1.png" width="691.2"></p>
<p>The RG value amplifies the NMR signal (free induction decay) before it is converted to a digital signal. In the plot above you can see, that there were different types of experiments performed (indicated by different linetypes) and that the RG is related to the TSP signal strength within each experiment type. In metabolic phenotyping, the RG is often fixed for spectra acquired within one analytical run as it sometimes can be diffucult to account for.</p>
</div>
</div>
<div id="calibration-also-often-referred-to-as-referencing" class="section level2">
<h2 class="hasAnchor">
<a href="#calibration-also-often-referred-to-as-referencing" class="anchor"></a>Calibration (also often referred to as referencing)</h2>
<p>Spectral calibration is an essential step in NMR data processing, where the entire spectrum is shifted until the peak apex of a reference compound reaches a defined ppm position. For urine NMR analysis the reference compounds is usually TSP, which gives rise to a singlet defined at zero ppm.<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<p>We can calibrate the urine spectra using the <strong><code>calibrate()</code></strong> function, as shown with the following code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># calibrate urinary NMR spectra to TSP</span>
X.cali=<span class="kw"><a href="../reference/calibration.html">calibration</a></span>(X, ppm, <span class="dt">type=</span><span class="st">'Urine'</span>)

<span class="co"># plot TSP overlay with calibrated data, facetted for each different experiment type</span>
<span class="kw"><a href="../reference/specOverlay.html">specOverlay</a></span>(X.cali, ppm, <span class="dt">shift=</span><span class="kw">c</span>(<span class="op">-</span><span class="fl">0.05</span>,<span class="fl">0.05</span>), 
            <span class="dt">an=</span><span class="kw">list</span>(<span class="st">'Experiment'</span>=meta<span class="op">$</span>a_EXP , 
                    <span class="st">'Run Order'</span>=meta<span class="op">$</span>a_RunOrder))</code></pre></div>
<p><img src="Imps_files/figure-html/calibration-1.png" width="691.2"></p>
<p>The plot above shows three panels, each for every experiment type and each spectra is coloured according to the run order. Now you can see that all TSP signals are nicely aligned with the peak apex centered at zero ppm (that was not the case before).</p>
<p>Both of the experiment types labelled <strong>&lt;&gt;</strong> and <strong>&lt;OB_flowtest&gt;</strong> (upper and lower panel in the above plot) are calibration experiments and were performed at the beginning of the run (as indicated by the colour). For quantitative analysis these are not suitable and therefore, we filter for the desired experiment type (<strong>&lt;JL-noe1d&gt;</strong>) before we continue with the analysis.</p>
<div id="filtering-based-on-spectrometer-metadata" class="section level3">
<h3 class="hasAnchor">
<a href="#filtering-based-on-spectrometer-metadata" class="anchor"></a>Filtering based on spectrometer metadata</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Exclude calibration experiments</span>
idx=<span class="kw">grep</span>(<span class="st">'noe1d'</span>, meta<span class="op">$</span>a_EXP)
X=X[idx,]
meta=meta[idx,]</code></pre></div>
</div>
</div>
<div id="assessment-of-spectral-quality" class="section level2">
<h2 class="hasAnchor">
<a href="#assessment-of-spectral-quality" class="anchor"></a>Assessment of spectral quality</h2>
<p>In metabolic phenotyping and in any other field where multiple NMR spectra are compared quantitatively, the quality of spectra is of particular importance. Assessment of spectral quality usually is a visual inspection of the water suppresion quality, spectral line widths and baseline stability as well as the average signal to noise (SN) ratio.</p>
<p>High throughput NMR often does not allow a manual inspection of each individual spectrum and automatically generated quality indices are used to exclude low quality spectra. The <strong><code>spec.qc()</code></strong> function derives several spectral quality control indices and produces an overview plot if the function argument plot is set to TRUE:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># calculate quality control measures</span>
spec.qc=<span class="kw"><a href="../reference/spec.quality.html">spec.quality</a></span>(X.cali, ppm, <span class="dt">ppm.noise=</span><span class="kw">c</span>(<span class="fl">9.4</span>,<span class="fl">9.5</span>), <span class="dt">plot=</span><span class="ot">TRUE</span>)</code></pre></div>
<p><img src="Imps_files/figure-html/spec%20qc%20I-1.png" width="691.2"></p>
<p>The output of this function is a dataframe containing the quality control indices for each sample:</p>
<ul>
<li>TSP line widht in ppm (related to the shim quality)</li>
<li>Area of the residual water signal (quality of water suppression)</li>
<li>Baseline area</li>
<li>Average signal to noise ratio</li>
</ul>
<p>The latter two paramters are primarily influenced by biological factors. For example, the area of the baseline depends on sample dilution (higher diluted samples have lower signals intensities, which leads to smaller baseline areas). However, these can still be useful for spotting extreme outliers of biological as well as technical nature.</p>
<p>The first few rows of the quality indices table are shown just below. Like for the NMR matrix <em>X</em>, the row names are the experiment folders.</p>
<table class="table">
<thead><tr class="header">
<th></th>
<th align="right">TSP.lw.ppm</th>
<th align="right">Residual.water</th>
<th align="right">Baseline</th>
<th align="right">SN.ratio</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td align="right">0.00346</td>
<td align="right">326444.4</td>
<td align="right">15349.98</td>
<td align="right">2.153720</td>
</tr>
<tr class="even">
<td>10</td>
<td align="right">0.00291</td>
<td align="right">533341.8</td>
<td align="right">23755.64</td>
<td align="right">1.843013</td>
</tr>
<tr class="odd">
<td>101</td>
<td align="right">0.00358</td>
<td align="right">2740742.5</td>
<td align="right">187430.28</td>
<td align="right">9.229576</td>
</tr>
<tr class="even">
<td>102</td>
<td align="right">0.00372</td>
<td align="right">2083055.4</td>
<td align="right">233873.91</td>
<td align="right">7.128838</td>
</tr>
<tr class="odd">
<td>103</td>
<td align="right">0.00317</td>
<td align="right">1257159.5</td>
<td align="right">41264.42</td>
<td align="right">4.028422</td>
</tr>
<tr class="even">
<td>104</td>
<td align="right">0.00330</td>
<td align="right">5691881.8</td>
<td align="right">343921.68</td>
<td align="right">8.350318</td>
</tr>
</tbody>
</table>
<p>Currently, the line width estimate of the <strong><code><a href="../reference/spec.quality.html">spec.quality()</a></code></strong> function (<em>TSP.lw.ppm</em>) requires a TSP signal or any other external reference compound that resonates at zero ppm. The respective line width in Hertz can be derived by multiplying <em>TSP.lw.ppm</em> with the spectrometer frequency in the <em>meta</em> dataframe:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># TSP line widht in Hz</span>
TSP.lw.Hz=spec.qc<span class="op">$</span><span class="st">"TSP.lw.ppm"</span> <span class="op">*</span><span class="st"> </span>meta<span class="op">$</span><span class="st">"a_SFO1"</span>
<span class="kw">hist</span>(TSP.lw.Hz, <span class="dt">xlab=</span><span class="st">'TSP line widht (Hz)'</span>, <span class="dt">main=</span><span class="st">'Histogram'</span>, <span class="dt">breaks =</span> <span class="st">"FD"</span>)</code></pre></div>
<p><img src="Imps_files/figure-html/spec%20qc%20II-1.png" width="691.2"></p>
</div>
<div id="excision-of-chemical-shifts-regions" class="section level2">
<h2 class="hasAnchor">
<a href="#excision-of-chemical-shifts-regions" class="anchor"></a>Excision of chemical shifts regions</h2>
<p>Further downstream analysis requires the excision of chemical shift regions where signals from external sources (e.g. buffer) are present or are non-quantitative. In urinary NMR analyses these include the TSP and residual water signal as well as ppm regions where there is no signal but only noise.</p>
<p>The function <strong><code><a href="../reference/get.idx.html">get.idx()</a></code></strong> can be used to obtain indices of the desired shift range from the ppm vector. These indices can then be further used to exclude the relevant columns in the NMR matrix and ppm vector. This is illustrated in the following code snippet.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Indexing TSP region and upfield noise...</span>
idx.TSP=<span class="kw"><a href="../reference/get.idx.html">get.idx</a></span>(<span class="dt">range=</span><span class="kw">c</span>(<span class="kw">min</span>(ppm), <span class="fl">0.5</span>), ppm)
<span class="co"># ... water region...</span>
idx.water=<span class="kw"><a href="../reference/get.idx.html">get.idx</a></span>(<span class="dt">range=</span><span class="kw">c</span>(<span class="fl">4.6</span>, <span class="dv">5</span>), ppm)
<span class="co"># ... as well as downfield noise regions</span>
idx.noiseDF=<span class="kw"><a href="../reference/get.idx.html">get.idx</a></span>(<span class="dt">range=</span><span class="kw">c</span>(<span class="fl">9.5</span>, <span class="kw">max</span>(ppm)), ppm)

<span class="co"># Exision of TSP, res. water and noise regions</span>
X.cali=X.cali[,<span class="op">-</span><span class="kw">c</span>(idx.TSP, idx.water, idx.noiseDF)]
ppm=ppm[<span class="op">-</span><span class="kw">c</span>(idx.TSP, idx.water, idx.noiseDF)]</code></pre></div>
</div>
<div id="baseline-correction" class="section level2">
<h2 class="hasAnchor">
<a href="#baseline-correction" class="anchor"></a>Baseline correction</h2>
<p>In 1D 1H NMR spectroscopy using simple pulse sequences, broad resonanes originating from macromolecules lead to increased spectral baselines. Baseline differences across spectra complicates the analysis and the the removal of often leads to more accurate results. In MetaboMate, a non-linear baseline correction can be performed with the <strong><code><a href="../reference/bline.html">bline()</a></code></strong> function. See the exmpale below for its input arguments and <strong><code><a href="../reference/bline.html">?bline</a></code></strong> for methodological information.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Baseline correction</span>
X.bl=<span class="kw"><a href="../reference/bline.html">bline</a></span>(X.cali)

<span class="co"># compare spectra before and after baseline correction</span>
<span class="kw"><a href="../reference/specOverlay.html">specOverlay</a></span>(X.cali, ppm, <span class="dt">shift=</span><span class="kw">c</span>(<span class="fl">3.6</span>,<span class="dv">4</span>), 
            <span class="dt">an=</span><span class="kw">list</span>(<span class="dt">panel=</span><span class="st">"Not BL corrected"</span>, 
                    <span class="st">"Baseline"</span>=spec.qc<span class="op">$</span><span class="st">"Baseline"</span>),
            <span class="dt">title=</span><span class="st">"Raw"</span>)

<span class="kw"><a href="../reference/specOverlay.html">specOverlay</a></span>(X.bl, ppm, <span class="dt">shift=</span><span class="kw">c</span>(<span class="fl">3.6</span>,<span class="dv">4</span>), 
            <span class="dt">an=</span><span class="kw">list</span>(<span class="dt">panel=</span><span class="st">"BL corrected"</span> , 
                    <span class="st">"SN ratio"</span>=spec.qc<span class="op">$</span><span class="st">"SN.ratio"</span>),
            <span class="dt">title=</span><span class="st">"Baseline corrected"</span>)</code></pre></div>
<p><img src="Imps_files/figure-html/baseline-1.png" width="691.2"><img src="Imps_files/figure-html/baseline-2.png" width="691.2"></p>
</div>
<div id="spectral-normalisation" class="section level2">
<h2 class="hasAnchor">
<a href="#spectral-normalisation" class="anchor"></a>Spectral normalisation</h2>
<p>Depending on the sample type, spectra may require normalisation prior to statistical analysis. For example, urine dilutions vary across samples, perhaps due to the uptake of different amounts of water. Normalisation methods can account for these kind of systematic differences in spectral intensities.</p>
<p>There are several normalisation methods avaiable. Among the most commonly applied ones are Total Area (TA) normalisation and Probablistic Quotient Normalisation (PQN).<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> In this tutorial, we normalise the spectra using both methods and compare the results. Therefore, the functions <strong><code><a href="../reference/pqn.html">pqn()</a></code></strong> and <strong><code>totaArea()</code></strong> are called, both returning the normalised NMR matrix. The additional input argument <em>add.DilF</em> indicates if the calculated dilution factors should be exported to the R workspace. Having a look at the calculated dilution factors can be very informative. For example, if pooled quality control samples were periodically included in the study run, then these should have very comparable dilution factors. The <strong>add.DilF</strong> argument specifies a user-given variable name and a vector variable named like this (containing the dilution factors) is automatically added to the R workspace after calling the function. Here’s an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
X.pqn=<span class="kw"><a href="../reference/pqn.html">pqn</a></span>(X.bl, <span class="dt">add.DilF =</span> <span class="st">'dilF.pqn'</span>)
X.ta=<span class="kw"><a href="../reference/totalArea.html">totalArea</a></span>(X.bl, <span class="dt">add.DilF=</span><span class="st">'dilF.ta'</span>)

<span class="kw">plot</span>(<span class="kw">log10</span>(dilF.pqn), <span class="kw">log10</span>(dilF.ta), <span class="dt">xlab=</span><span class="st">'PQN Dilution Factor'</span>, <span class="dt">ylab=</span><span class="st">'Total Area (scaled)'</span>)
<span class="kw">abline</span>(<span class="dt">a =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="dt">col=</span><span class="st">'red'</span>)</code></pre></div>
<p><img src="Imps_files/figure-html/normalisation-1.png" width="691.2"></p>
<p>Plotting the dilution factors of both normalisation factors against each other, shows that these are genearlly lower for PQN than for TA normalisation. Which normalisation method is more appropriate generally depends on the sample type, experimental setup and analysis platform. In NMR-based untargeted metabolic phenotyping studies using urine as a sample matrix I recommend using PQN instead of TA normalisation.</p>
<p>The last step is a final visual inspection of the pre-processed NMR spectra:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/matspec.html">matspec</a></span>(ppm, X.pqn, <span class="dt">shift =</span> <span class="kw">range</span>(ppm))
<span class="kw"><a href="../reference/matspec.html">matspec</a></span>(ppm, X.pqn, <span class="dt">shift =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))
<span class="kw"><a href="../reference/matspec.html">matspec</a></span>(ppm, X.pqn, <span class="dt">shift =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">6</span>))
<span class="kw"><a href="../reference/matspec.html">matspec</a></span>(ppm, X.pqn, <span class="dt">shift =</span> <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">9</span>))</code></pre></div>
<p><img src="Imps_files/figure-html/visal%20check-1.png" width="691.2"><img src="Imps_files/figure-html/visal%20check-2.png" width="691.2"><img src="Imps_files/figure-html/visal%20check-3.png" width="691.2"><img src="Imps_files/figure-html/visal%20check-4.png" width="691.2"></p>
</div>
<div id="summary-and-further-steps" class="section level1">
<h1 class="hasAnchor">
<a href="#summary-and-further-steps" class="anchor"></a>Summary and further steps</h1>
<p>The raw spectra were quality checked and pre-processed including calibration to TSP, removal of non-quantitative or technical signals, as well as regions which contain only noise. Further, the urine-derived spectra were normalised with PQN to account for sample dilution effects. Further filtering steps could be applied based on the established quality indices (eg., using TSP line widths as an estimate for shimming quality).</p>
<p>Spectra are now prepared for statistical analysis. Commonly applied analysis methods in metabolic profiling include Prinicpal Component Analysis (PCA) and Orthogoanl-Partial-Least Squares (O-PLS). You can find more information on this in the vignette <strong>Multivariate Statistical Analysis</strong> of the <em>MetaboMate</em> package.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Li, Jia V., <em>et al.</em> (2011) Metabolic surgery profoundly influences gut microbial-host metabolic cross-talk. <em>Gut</em> 60.9, 1214-1223.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Dona, A.C., <em>et al.</em> (2014) Precision high-throughput proton NMR spectroscopy of human urine, serum, and plasma for large-scale metabolic phenotyping. <em>Analytical Chemistry</em>. 86.19. 9887-94.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Dieterly, F.,  (2006), Probabilistic Quotient Normalization as Robust Method to Account for Dilution of Complex Biological Mixtures. Application in 1H NMR Metabonomics, , 78.3, 4281-90<a href="#fnref3">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#reading-1d-nmr-spectra">Reading 1D NMR spectra</a></li>
      <li><a href="#plotting-spectra">Plotting spectra</a></li>
      <li><a href="#calibration-also-often-referred-to-as-referencing">Calibration (also often referred to as referencing)</a></li>
      <li><a href="#assessment-of-spectral-quality">Assessment of spectral quality</a></li>
      <li><a href="#excision-of-chemical-shifts-regions">Excision of chemical shifts regions</a></li>
      <li><a href="#baseline-correction">Baseline correction</a></li>
      <li><a href="#spectral-normalisation">Spectral normalisation</a></li>
      <li><a href="#summary-and-further-steps">Summary and further steps</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kimhofer Torben.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
